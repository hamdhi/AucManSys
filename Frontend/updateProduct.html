<!DOCTYPE html>
<html>
<head>
    <title>Update Product</title>
    <link rel="stylesheet" href="General.css">
</head>
<body>
    <h2>Update Product</h2>
    
    [ <h2 id="displayUsername"></h2> ]

    <form id="updateForm">
        <input type="number" id="catId" placeholder="Category ID" required />
        <!-- <input type="text" id="username" placeholder="Username" required /> Username taken from session -->
        <input type="text" id="name" placeholder="Product Name" required />
        <input type="text" id="description" placeholder="Description" required />
        <input type="number" id="minBid" placeholder="Min Bid" required />
        <input type="number" id="status" placeholder="Status (1/0)" required />
        <input type="text" id="photo" placeholder="Photo URL" />
        <input type="date" id="endDate" placeholder="End Date" required />
        <button type="submit">Update Product</button>
    </form>

    <script>

         // Display logged in username
        const username = sessionStorage.getItem("username");
        document.getElementById("displayUsername").textContent = "Logged in as: " + (username ?? "Unknown");

        const params = new URLSearchParams(window.location.search);
        const productId = parseInt(params.get('id')); // parse productId as int

        async function loadProduct() {
            const res = await fetch(`https://localhost:7212/api/Product/getById/${productId}`);
            const p = await res.json();
            document.getElementById('catId').value = p.cat_Id;
            document.getElementById('name').value = p.product_Name;
            document.getElementById('description').value = p.description;
            document.getElementById('minBid').value = p.min_Bid_Price;
            document.getElementById('status').value = p.status;
            document.getElementById('photo').value = p.photo;
            
            document.getElementById('endDate').value = new Date(p.end_Date).toISOString().split('T')[0];
        }

        document.getElementById('updateForm').addEventListener('submit', async e => {
            e.preventDefault();
            const dto = {
                cat_Id: parseInt(document.getElementById('catId').value), // parse cat_Id as int
                username: sessionStorage.getItem("username"), // take from session
                product_Name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                min_Bid_Price: parseFloat(document.getElementById('minBid').value),
                status: parseInt(document.getElementById('status').value),
                photo: document.getElementById('photo').value,
                end_Date: document.getElementById('endDate').value
            };

            const res = await fetch(`https://localhost:7212/api/Product/update/${productId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dto)
            });

            if(res.ok){
                alert('Product updated!');
                window.location.href = 'Bidder.html';
            } else {
                const error = await res.text();
                alert('Update failed: ' + error);
            }
        });

        window.addEventListener('DOMContentLoaded', loadProduct);
    </script>
</body>
</html>
