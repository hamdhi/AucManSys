<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products</title>
    <link rel="stylesheet" href="General.css">
</head>

<body>
    <h2 id="di"></h2>
    <h2 id="displayUsername"></h2>

    <!-- Admin-only button -->
    <div id="adminButtons"></div>

    <!-- Logout -->
    <button onclick="logout()">Logout</button>

    <!-- Add Product Form -->
    <h3>Add New Product</h3>
    <p id="inactiveMsg" style="color:red; display:none;">You Are An Inactive Seller, Cannot Add Or Update Products.</p>
    <form id="addForm">
        <select id="catId">
            <option value="1">Electronic</option>
            <option value="2">Fashion</option>
            <option value="3">Home and Furniture</option>
        </select>
        <input type="text" id="name" placeholder="Product Name" required />
        <input type="text" id="description" placeholder="Description" required />
        <input type="number" id="minBid" placeholder="Min Bid" required />
        <select id="status">
            <option value="0">Not Available</option>
            <option value="1">Available</option>
        </select>
        <input type="text" id="photo" placeholder="Photo URL" />
        <input type="date" id="endDate" placeholder="End Date" required />
        <button type="submit" id="addBtn">Add Product</button>
    </form>

    <h1>Products</h1>
    <table id="productsTable" border="1">
        <thead>
            <tr>
                <th>ID</th>
                <th>Category Name</th>
                <th>Username</th>
                <th>Name</th>
                <th>Description</th>
                <th>Min Bid Price</th>
                <th>Status</th>
                <th>Photo</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const username = sessionStorage.getItem("username");
        const role = sessionStorage.getItem("userRole");
        let isActiveSeller = true; // default assume active

        document.getElementById("displayUsername").textContent = "Logged in as: " + (username ?? "Unknown");

        // Admin-only button
        if (role === "Admin") {
            const btn = document.createElement("button");
            btn.textContent = "View Users List";
            btn.onclick = () => window.location.href = "UserList.html";
            document.getElementById("adminButtons").appendChild(btn);
        }

        // Fetch current user to check if seller is active
        async function checkCurrentUser() {
            try {
                const res = await fetch('https://localhost:7212/api/UserAuth/current', { credentials: 'include' });
                if (!res.ok) throw new Error('Cannot fetch current user');
                const user = await res.json();

                if (user.role === "Seller" && !user.isActive) {
                    isActiveSeller = false;
                    document.getElementById("addForm").style.display = "none";
                    document.getElementById("inactiveMsg").style.display = "block";
                    // Disable all edit buttons for products later
                }
            } catch (err) {
                console.error(err);
                alert('Error checking user status');
            }
        }

        const tableBody = document.querySelector('#productsTable tbody');

        async function loadProducts() {
            const res = await fetch('https://localhost:7212/api/Product/getAll');
            const products = await res.json();
            tableBody.innerHTML = '';
            products.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${p.product_Id}</td>
                    <td>${p.categoryName}</td>
                    <td>${p.username}</td>
                    <td>${p.product_Name}</td>
                    <td>${p.description}</td>
                    <td>${p.min_Bid_Price}</td>
                    <td>${p.status == 1 ? 'Available' : 'Not Available'}</td>
                    <td>${p.photo}</td>
                    <td>${new Date(p.start_Date).toLocaleString()}</td>
                    <td>${new Date(p.end_Date).toLocaleDateString()}</td>
                    <td>
                        <button onclick="editProduct(${p.product_Id})" ${!isActiveSeller ? "disabled" : ""}>Edit</button>
                        <button onclick="deleteProduct(${p.product_Id})">Delete</button>
                        <button onclick="viewProduct(${p.product_Id})">View</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Add product
        document.getElementById('addForm').addEventListener('submit', async e => {
            e.preventDefault();
            if (!isActiveSeller) return;

            const dto = {
                cat_Id: +document.getElementById('catId').value,
                username: username,
                product_Name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                min_Bid_Price: +document.getElementById('minBid').value,
                status: +document.getElementById('status').value,
                photo: document.getElementById('photo').value,
                end_Date: document.getElementById('endDate').value
            };
            await fetch('https://localhost:7212/api/Product/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dto),
                credentials: 'include'
            });
            loadProducts();
        });

        function editProduct(id) {
            if (!isActiveSeller) {
                alert("Inactive sellers cannot edit products.");
                return;
            }
            window.location.href = `updateProduct.html?id=${id}`;
        }

        function viewProduct(id) {
            window.location.href = `viewProduct.html?productId=${id}`;
        }

        async function deleteProduct(id) {
            if (confirm('Delete this product?')) {
                await fetch(`https://localhost:7212/api/Product/delete/${id}`, { method: 'DELETE', credentials: 'include' });
                loadProducts();
            }
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = "login.html";
        }

        window.addEventListener('DOMContentLoaded', async () => {
            await checkCurrentUser();
            loadProducts();
        });

        // Security check
        if (!["Admin", "Seller", "Bidder"].includes(role)) {
            alert("Access denied! Redirecting to login.");
            window.location.href = "login.html";
        }
    </script>
</body>
</html>
