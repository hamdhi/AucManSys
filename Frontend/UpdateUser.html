<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update User</title>
    <link rel="stylesheet" href="General.css">
</head>

<body>
    [ <h2 id="displayUsername"></h2> ]
    <button onclick="logout()">Logout</button>
    <button onclick="window.location.href='Admin.html'">Back to Admin Panel</button>
    <br /><br />

    <h2>Update User</h2>

    <form id="updateForm">
        <input type="text" id="username" placeholder="Username" />
        <input type="email" id="email" placeholder="Email" required />
        <select id="role" required>
            <option value="">Select Role</option>
            <option value="Admin">Admin</option>
            <option value="Seller">Seller</option>
            <option value="Bidder">Bidder</option>
        </select>
        <input type="password" id="password" placeholder="New Password (leave blank to keep old)" />
        <label>
            <input type="checkbox" id="isActive" /> Active
        </label>
        <button type="submit">Update User</button>
    </form>

    <script>
        const params = new URLSearchParams(window.location.search);
        const userId = params.get('id');

        async function loadUser() {
            try {
                const res = await fetch(`https://localhost:7212/api/UserAuth/getById/${userId}`);
                if (!res.ok) throw new Error('Failed to load user');
                const user = await res.json();
                document.getElementById('username').value = user.username;
                document.getElementById('email').value = user.email;
                document.getElementById('role').value = user.role;
                document.getElementById('isActive').checked = user.isActive;
            } catch (err) {
                alert(err.message);
            }
        }

        // Submit updated info
        document.getElementById('updateForm').addEventListener('submit', async e => {
            e.preventDefault();
            const password = document.getElementById('password').value.trim();
            const dto = {
                Email: document.getElementById('email').value,
                Username: document.getElementById('username').value, // include username
                Role: document.getElementById('role').value,
                IsActive: document.getElementById('isActive').checked,
                PasswordHash: password.length ? password : null
            };

            try {
                const res = await fetch(`https://localhost:7212/api/UserAuth/update/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dto)
                });

                if (!res.ok) {
                    const msg = await res.text();
                    throw new Error(msg);
                }

                alert('User updated successfully!');
                window.location.href = 'Admin.html';
            } catch (err) {
                alert('Update failed: ' + err.message);
            }
        });

        window.addEventListener('DOMContentLoaded', loadUser);
    </script>

    <script>
        // Logout function
        function logout() {
            sessionStorage.clear();
            window.location.href = "login.html";
        }
        // Security check: allow only Admin
        const role = sessionStorage.getItem("userRole");
        if (role !== "Admin") {
            alert("Access denied! Redirecting to login.");
            window.location.href = "login.html";
        }
        // Display logged in username
        const username = sessionStorage.getItem("username");
        document.getElementById("displayUsername").textContent = "Logged in as: " + (username ?? "Unknown");
    </script>
</body>

</html>